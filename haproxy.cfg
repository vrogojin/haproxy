global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s

# =============================================================================
# HTTP Frontend (Port 80)
# =============================================================================
frontend http-in
    mode http
    bind *:80

    # ACLs for domain-based routing
    acl host_friendly_miners hdr(host) -i friendly-miners.dyndns.org
    acl host_ipfs hdr(host) -i unicity-ipfs1.dyndns.org

    # Route to appropriate backend
    use_backend friendly-dashboard-http if host_friendly_miners
    use_backend ipfs-kubo-http if host_ipfs

    # Default backend (optional - returns 503 if no match)
    default_backend no-match

# =============================================================================
# HTTPS Frontend (Port 443) - SSL Passthrough
# =============================================================================
frontend https-in
    mode tcp
    bind *:443

    # Wait to inspect SNI
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # ACLs for SNI-based routing
    acl sni_friendly_miners req.ssl_sni -i friendly-miners.dyndns.org
    acl sni_ipfs req.ssl_sni -i unicity-ipfs1.dyndns.org

    # Route to appropriate backend
    use_backend friendly-dashboard-https if sni_friendly_miners
    use_backend ipfs-kubo-https if sni_ipfs

    # Default backend (optional - returns connection refused if no match)
    default_backend no-match-tcp

# =============================================================================
# HTTP Backends
# =============================================================================
backend friendly-dashboard-http
    mode http
    server friendly-dashboard friendly-dashboard:80 check init-addr last,libc,none

backend ipfs-kubo-http
    mode http
    server ipfs-kubo ipfs-kubo:80 check init-addr last,libc,none

# =============================================================================
# HTTPS Backends (SSL Passthrough)
# =============================================================================
backend friendly-dashboard-https
    mode tcp
    server friendly-dashboard friendly-dashboard:443 check init-addr last,libc,none

backend ipfs-kubo-https
    mode tcp
    server ipfs-kubo ipfs-kubo:443 check init-addr last,libc,none

# =============================================================================
# Default Backends (No Match)
# =============================================================================
backend no-match
    mode http
    http-request deny deny_status 503

backend no-match-tcp
    mode tcp
    # TCP mode has no built-in deny, connections will simply fail
